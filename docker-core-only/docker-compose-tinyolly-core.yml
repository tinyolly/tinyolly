services:
  redis:
    image: redis:7-alpine
    container_name: tinyolly-redis
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  tinyolly-otlp-receiver:
    build:
      context: ./apps/tinyolly-otlp-receiver
      dockerfile: ../../../docker/dockerfiles/Dockerfile.tinyolly-otlp-receiver
    container_name: tinyolly-otlp-receiver
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
    ports:
      - "4319:4317"  # OTLP gRPC receiver (exposed on 4319 to avoid conflict with Elastic EDOT on 4317)

  # No otel-collector service - use external collector (e.g., Elastic EDOT)
  # Configure your external collector to send to: localhost:4319 (gRPC)
  # Note: TinyOlly receiver only supports gRPC. For HTTP support, use an external collector
  #       that accepts HTTP and forwards via gRPC to this receiver.
  # Port 4319 is used instead of 4317 to avoid conflict with Elastic EDOT collector on 4317.

  tinyolly:
    build:
      context: ./apps/tinyolly-ui
      dockerfile: ../../../docker/dockerfiles/Dockerfile.tinyolly-ui
    container_name: tinyolly
    ports:
      - "5005:5002"  # Changed to 5005 to avoid conflict with K8s (which uses 5002)
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis

networks:
  default:
    name: tinyolly-network

